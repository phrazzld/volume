# Volume - Environment Variables Template
# Copy this to .env.local for local development

# === Local Development (Personal Dev Database) ===
# This deployment is for your local development and testing
CONVEX_DEPLOYMENT=dev:curious-salamander-943
NEXT_PUBLIC_CONVEX_URL=https://curious-salamander-943.convex.cloud

# === Convex Deploy Keys (Vercel Only - DO NOT set locally) ===
# These are set in Vercel dashboard and determine which Convex deployment
# receives your function deployments during build.

# Production (set in Vercel production environment):
# CONVEX_DEPLOY_KEY=prod:whimsical-marten-631|<secret>

# Preview (set in Vercel preview environment):
# CONVEX_DEPLOY_KEY=preview:phaedrus:volume|<secret>

# === Clerk Authentication (All Environments) ===
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_YOUR_PUBLISHABLE_KEY_HERE
CLERK_SECRET_KEY=sk_test_YOUR_SECRET_KEY_HERE
CLERK_JWT_ISSUER_DOMAIN=https://your-clerk-domain.clerk.accounts.dev

# === CRITICAL: Deployment Architecture ===
#
# Local Development:
#   - Uses CONVEX_DEPLOYMENT (points directly to dev deployment)
#   - No deploy key needed (read-only connection)
#   - Your personal sandbox for testing
#
# Vercel Production:
#   - Uses CONVEX_DEPLOY_KEY with "prod:" prefix
#   - Deploys functions to production Convex deployment
#   - NEXT_PUBLIC_CONVEX_URL auto-updated during build
#   - Production user data lives here
#
# Vercel Preview:
#   - Uses CONVEX_DEPLOY_KEY with "preview:" prefix
#   - Auto-creates isolated ephemeral deployment per PR
#   - Separate database from prod and dev
#   - Auto-cleanup after 14 days of inactivity
#
# === WARNING ===
# NEVER mix deployment names with wrong deploy keys!
# The deploy key determines which Convex deployment receives your functions.
# Getting this wrong can cause data to be deployed to the wrong environment.
#
# Example of WRONG configuration (causes data loss):
#   CONVEX_DEPLOYMENT=dev:curious-salamander-943  # ❌ Dev name
#   CONVEX_DEPLOY_KEY=prod:whimsical-marten-631   # ❌ Prod key
#   → Functions deploy to prod, but app connects to dev
#   → Result: App shows empty database
#
# Example of CORRECT configuration:
#   CONVEX_DEPLOY_KEY=prod:whimsical-marten-631   # ✅ Prod key only
#   → Convex auto-sets NEXT_PUBLIC_CONVEX_URL during build
#   → Functions and app both use production deployment

# === CRITICAL: 2025-10-29 Incident - Deployment Misconfiguration ===
#
# VERCEL ENVIRONMENTS (Production & Preview):
# ✅ DO: Set only CONVEX_DEPLOY_KEY
# ❌ DON'T: Set CONVEX_DEPLOYMENT (causes misconfiguration)
# ❌ DON'T: Set NEXT_PUBLIC_CONVEX_URL (Convex auto-sets during build)
#
# HOW IT WORKS:
# 1. vercel.json runs: npx convex deploy --cmd-url-env-var-name NEXT_PUBLIC_CONVEX_URL --cmd 'pnpm run build'
# 2. Convex CLI reads CONVEX_DEPLOY_KEY from environment
# 3. CLI deploys functions to key's target deployment
# 4. CLI injects NEXT_PUBLIC_CONVEX_URL automatically during build
# 5. App connects to correct deployment
#
# WHAT WENT WRONG (2025-10-29):
# - Vercel production had explicit CONVEX_DEPLOYMENT=dev:curious-salamander-943
# - Vercel production had CONVEX_DEPLOY_KEY=prod:whimsical-marten-631
# - Functions deployed to prod (via deploy key), but app connected to dev (via explicit URL)
# - Result: Production appeared to have empty database (data was safe in dev)
#
# THE FIX:
# - Removed CONVEX_DEPLOYMENT from Vercel environments
# - Removed NEXT_PUBLIC_CONVEX_URL from Vercel environments
# - Added --cmd-url-env-var-name flag to vercel.json build command
# - Now deploy key controls everything (single source of truth)
